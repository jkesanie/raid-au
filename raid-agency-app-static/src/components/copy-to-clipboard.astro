---
// CopyToClipboard.astro
interface Props {
  text: string;
  className?: string;
  size?: number;
}

const { 
  text, 
  className = "",
  size = 20
} = Astro.props;
---

<button 
  class={`copy-to-clipboard ${className}`}
  data-text={text}
  aria-label="Copy to clipboard"
  type="button"
>
  <svg class="icon copy-icon" xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
  </svg>
  
  <svg class="icon check-icon" xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" hidden>
    <polyline points="20 6 9 17 4 12"></polyline>
  </svg>
</button>

<style>
  .copy-to-clipboard {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    background: none;
    border: none;
    padding: 0 4px;
    cursor: pointer;
    color: #6b7280;
    transition: color 0.2s;
    vertical-align: middle;
  }

  .copy-to-clipboard:hover {
    color: #374151;
  }

  .copy-to-clipboard:active {
    transform: scale(0.95);
  }

  .copy-to-clipboard.copied {
    color: #10b981;
  }

  .icon {
    display: block;
    transition: opacity 0.2s;
  }

  .copy-icon {
    display: block;
  }

  .check-icon {
    display: none;
  }

  .copy-to-clipboard.copied .copy-icon {
    display: none;
  }

  .copy-to-clipboard.copied .check-icon {
    display: block;
  }
</style>

<script>
  function initCopyButtons() {
    const buttons = document.querySelectorAll('.copy-to-clipboard') as NodeListOf<HTMLElement>;
    
    buttons.forEach(button => {
      // Remove existing listeners by cloning
      const newButton = button.cloneNode(true) as HTMLElement;
      button.parentNode?.replaceChild(newButton, button);
      
      newButton.addEventListener('click', async (e) => {
        e.preventDefault();
        e.stopPropagation();
        
        const text = newButton.getAttribute('data-text');

        if (!text) {
          console.error('No text to copy');
          return;
        }
        
        try {
          await navigator.clipboard.writeText(text);
          
          newButton.classList.add('copied');
          const checkIcon = newButton.querySelector('.check-icon');
          const copyIcon = newButton.querySelector('.copy-icon');
          
          if (checkIcon) checkIcon.removeAttribute('hidden');
          if (copyIcon) copyIcon.setAttribute('hidden', '');
          
          setTimeout(() => {
            newButton.classList.remove('copied');
            if (checkIcon) checkIcon.setAttribute('hidden', '');
            if (copyIcon) copyIcon.removeAttribute('hidden');
          }, 2000);
        } catch (err: unknown) {
          console.error('Failed to copy:', err);
          const message = err instanceof Error ? err.message : String(err);
          alert('Failed to copy to clipboard. Error: ' + message);
        }
      });
    });
  }

  // Initialize on page load
  initCopyButtons();
  
  // Re-initialize after Astro view transitions
  document.addEventListener('astro:page-load', initCopyButtons);
</script>